<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>InstaCopy - Home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .post-card { margin-bottom: 20px; }
        .like-button { border: none; background: none; cursor: pointer; }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <h1 class="text-center mb-4">InstaCopy</h1>
		
		<div class="card shadow-sm mb-3">
		    <div class="card-body d-flex justify-content-around align-items-center">
		        <h4 class="mb-0">@<span th:text="${profileName}">GuestUser</span></h4>
		        <div>
		            <span class="text-muted">フォロー中:</span>
		            <strong class="following-count" th:text="${followingCount}">0</strong>
		        </div>
		        <div>
		            <span class="text-muted">フォロワー:</span>
		            <strong class="follower-count" th:text="${followerCount}">0</strong>
		        </div>
		    </div>
		</div>

        <div class="card shadow-sm mb-5">
            <div class="card-body">
                <form th:action="@{/post}" method="post" class="row g-3">
                    <div class="col-md-5">
                        <input type="text" name="imageUrl" class="form-control" placeholder="画像のURLを入力" required>
                    </div>
                    <div class="col-md-5">
                        <input type="text" name="comment" class="form-control" placeholder="コメントを入力" required>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">投稿</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="row row-cols-1 row-cols-md-3 g-4">
            <div class="col" th:each="post : ${posts}">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <span class="fw-bold">@Admin</span>
						
						
						<button type="button" 
						        th:classappend="${post.following} ? 'btn-primary' : 'btn-outline-primary'" 
						        class="btn btn-sm follow-button" 
						        
								th:data-data-name="${post.authorName != null ? post.authorName : 'Admin'}"

								th:data-name="'Admin'"
								
						        th:text="${post.following} ? 'フォロー中' : 'フォローする'">
						    フォローする
						</button>
						
                    </div>

                    <img th:src="${post.imageUrl}" class="card-img-top" alt="post image" style="height: 250px; object-fit: cover;">
                    
                    <div class="card-body">
                        <p class="card-text" th:text="${post.comment}"></p>
                        <small class="text-muted" th:text="${#temporals.format(post.createdAt, 'yyyy/MM/dd HH:mm')}"></small>
                        
                        <div class="mt-3 d-flex justify-content-between align-items-center">
                            <button type="button" class="like-button" th:data-id="${post.id}">
                                ❤️ <span class="likes-count" th:text="${post.likesCount}">0</span>
                            </button>

                            <div class="btn-group">
                                <a th:href="@{/post/edit/{id}(id=${post.id})}" class="btn btn-sm btn-outline-secondary">編集</a>
                                <form th:action="@{/post/delete/{id}(id=${post.id})}" method="post" onsubmit="return confirm('マジで削除しますか？')" style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">削除</button>
                                </form>
                            </div>
                            </div>
                    </div>
                </div>
            </div> 
        </div>
    </div>

    <script>
        // DOMContentLoadedで囲むことで確実にボタンを探せるようにします
        document.addEventListener('DOMContentLoaded', () => {
            
			// フォロー処理
			document.querySelectorAll('.follow-button').forEach(button => {
			    button.addEventListener('click', function() {
			        const targetName = this.getAttribute('data-name');
			        
			        // 送信は1回だけにします
			        fetch(`/follow/${targetName}`, {
			            method: 'POST',
			            headers: { 'X-Requested-With': 'XMLHttpRequest' }
			        })
			        .then(response => response.text())
			        .then(status => {
			            // サーバー側で処理が終わったら、ページをリロードする
			            // これにより、Java側の isFollowingAdmin 判定が最新の状態で反映されます
			            location.reload(); 
			        });
			    });
			});
			
            // いいね処理
            document.querySelectorAll('.like-button').forEach(button => {
                button.addEventListener('click', function() {
                    const postId = this.getAttribute('data-id');
                    const countSpan = this.querySelector('.likes-count');

                    fetch(`/post/${postId}/like`, {
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(response => response.json())
                    .then(newCount => {
                        countSpan.textContent = newCount;
                        this.style.color = 'red';
                        this.style.transform = 'scale(1.3)';
                        this.style.transition = '0.2s';
                        setTimeout(() => this.style.transform = 'scale(1.0)', 200);
                    });
                });
            });
        });
    </script>
</body>
</html>